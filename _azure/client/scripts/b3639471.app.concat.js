"use strict";angular.module("n4j",["n4j.common","n4j.pages","n4j.templates"]),angular.module("n4j").config(["$locationProvider","$urlRouterProvider",function($locationProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$locationProvider.html5Mode(!0)}]).run(["$rootScope","$state","$stateParams",function($rootScope,$state,$stateParams){$rootScope.$state=$state,$rootScope.$stateParams=$stateParams}]),angular.module("n4j.templates",[]),angular.module("n4j.common",["n4j.common.utils","n4j.common.directives"]),angular.module("n4j.common.utils",[]),angular.module("n4j.common.directives",[]),angular.module("n4j.common.utils").factory("_",function(){return window._}).factory("utils",function(){var utils={};return utils.getRandomInt=function(min,max){return Math.floor(Math.random()*(max-min+1))+min},utils}),angular.module("n4j.pages",["angular-growl","highcharts-ng","ngAnimate","ngResource","ngCookies","restangular","ui.bootstrap","ui.router.compat","n4j.pages.controllers","n4j.pages.directives","n4j.pages.services"]),angular.module("n4j.pages").config(["$stateProvider","RestangularProvider","$httpProvider","growlProvider",function($stateProvider,RestangularProvider,$httpProvider,growlProvider){$stateProvider.state("home",{url:"/",templateUrl:"pages/templates/home.tpl.html",controller:"HomeCtrl",data:{bodyId:"home"}}).state("login",{url:"/login",templateUrl:"pages/templates/login.tpl.html",controller:"AuthCtrl",data:{bodyId:"auth"},resolve:{auth:function($q,$window,$n4Auth){var deferred=$q.defer();return $n4Auth.isLoggedIn()?$window.location.href="/profile":deferred.resolve(),deferred.promise}}}).state("app",{"abstract":!0,url:"/app",templateUrl:"pages/templates/protected.tpl.html",resolve:{auth:function($q,$window,$n4Auth){var deferred=$q.defer();return $n4Auth.isLoggedIn()?deferred.resolve():$window.location.href="/login",deferred.promise},user:function($n4User){return $n4User.get()}}}).state("app.browse",{"abstract":!0,url:"^/browse",templateUrl:"pages/templates/browse.tpl.html",controller:"BrowseCtrl",resolve:{jobs:function($n4Jobs){return $n4Jobs.list()}}}).state("app.browse.list",{url:"",templateUrl:"pages/templates/browse.list.tpl.html"}).state("app.browse.detail",{url:"/:id",views:{detail:{controller:"BrowseDetailCtrl",templateUrl:"pages/templates/browse.detail.tpl.html"}}}).state("app.profile",{url:"^/profile",templateUrl:"pages/templates/profile.tpl.html",controller:"ProfileCtrl",data:{bodyId:"profile"}}).state("app.setup",{"abstract":!0,url:"^/profile/setup",template:"<div ui-view></div>"}).state("app.setup.locations",{url:"/locations",templateUrl:"pages/templates/setup.locations.tpl.html",controller:"SetupCtrl",data:{bodyId:"profile"}}).state("app.setup.skills",{url:"/skills",templateUrl:"pages/templates/setup.skills.tpl.html",controller:"SetupCtrl",data:{bodyId:"profile"}}),RestangularProvider.setBaseUrl("/api/v0"),RestangularProvider.setDefaultHeaders({api_key:"special-key"}),RestangularProvider.addResponseInterceptor(function(data,operation){var extracted=null;return"getList"===operation?extracted=data.list:"get"===operation?(extracted=data.node.data,extracted.nodeId=data.node.nodeId):extracted=data,extracted}),$httpProvider.defaults.transformRequest.unshift(function(data){var key,result=[];for(key in data)data.hasOwnProperty(key)&&result.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key]));return result.join("&")}),growlProvider.globalTimeToLive(3e3)}]),angular.module("n4j.pages.controllers",[]),angular.module("n4j.pages.directives",[]),angular.module("n4j.pages.services",[]),angular.module("n4j.pages.controllers").controller("BaseCtrl",["$rootScope","$scope","$state","$stateParams","_",function($rootScope,$scope,$state,$stateParams,_){var getBodyId,getBodyClasses;getBodyId=function(){return $state.current.data&&$state.current.data.bodyId?$state.current.data.bodyId:void 0},getBodyClasses=function(){var classes,merged;return classes=[],$state.current.data&&$state.current.data.bodyClasses&&(classes=classes.concat($state.current.data.bodyClasses.split(" "))),classes.push($stateParams.page?"page-"+$state.$current.parent.name.replace(/\./,"-"):"page-"+$state.current.name.replace(/\./g,"-")),merged="page",_.forEach($stateParams,function(val,key){"page"!==key&&(merged+="-"+val,classes.push(merged))}),classes.join(" ")},$rootScope.$on("$stateChangeSuccess",function(){$scope.bodyId=getBodyId(),$scope.bodyClasses=getBodyClasses()})}]),angular.module("n4j.pages.controllers").controller("AuthCtrl",function(){}),angular.module("n4j.pages").controller("BrowseCtrl",["_","$rootScope","$scope","$state","$stateParams","$resource","jobs","$n4User","$n4Jobs","growl",function(_,$rootScope,$scope,$state,$stateParams,$resource,jobs,$n4User,$n4Jobs,growl){$scope.jobs=jobs,$scope.currentJob=null,$scope.listType="Recommended";var loadMore=function(){var type="",listType=$scope.listType;"Likes"===listType&&(type="likes"),"Latest"===listType&&(type="latest"),$n4Jobs.list(type).then(function(jobs){var ids=_.map(jobs,function(job){return job.id});jobs=_.filter(jobs,function(job){return!_.contains(ids,job.id)}),$scope.jobs=$scope.jobs.concat(jobs)})};$scope.goTo=function(job){$scope.currentJob=job,$state.go("app.browse.detail",{id:job.id})},$scope.rate=function(job,rating){var jobId=job.id,msg="",index=_.findIndex(jobs,function(job){return job.id===jobId});msg="like"===rating?"Successfully liked "+job.title:"Successfully disliked "+job.title,$n4User.rateJob(jobId,rating).then(function(){growl.addSuccessMessage(msg),$scope.currentJob.id===jobId&&$scope.goTo($scope.jobs[index+1]),$scope.jobs.splice(index,1),$scope.jobs.length<=10&&loadMore()})},$scope.archive=function(job){console.log("@TODO Archive",job)},$scope.show=function(listType){var type="";"Likes"===listType&&(type="likes"),"Latest"===listType&&(type="latest"),$scope.listType=listType,$n4Jobs.list(type).then(function(jobs){$scope.jobs=jobs})},$stateParams.id||$scope.goTo(jobs[0])}]),angular.module("n4j.pages").controller("BrowseDetailCtrl",["_","$rootScope","$scope","$stateParams","$n4Jobs","jobs","user",function(_,$rootScope,$scope,$stateParams,$n4Jobs,jobs,user){var userSkills=_.map(user.skills,function(skill){return skill.data.normalized}),colors=["#F25A29","#AD62CE","#30B6AF","#FCC940","#FF6C7C","#4356C0","#DFE1E3"];_.each($scope.currentJob,function(val,key){$scope[key]=val}),$scope.jobTitle=$scope.title,$scope.hasSkill=function(skill){return _.contains(userSkills,skill.normalized)},$scope.isOldJob=function(date){var today=new Date;return date=Date.parse(date),today-date>15552e6},$scope.chartDateRange="day",$scope.chartConfig={options:{colors:colors,legend:{align:"center",floating:!1,itemStyle:{fontSize:"10px"},symbolHeight:12,symbolWidth:12,verticalAlign:"top"},plotOptions:{series:{lineWidth:2},area:{fillOpacity:.2,dashStyle:"ShortDot"}},chart:{type:"area"}},series:[{name:"Applicants",yAxis:0,pointInterval:864e5,pointStart:Date.UTC(2014,5,28),data:[5,10,15,12,8,7,18],style:{color:colors[0]}},{name:"Angel List Score",yAxis:1,pointInterval:864e5,pointStart:Date.UTC(2014,5,28),data:[36,51,47,67,72,80,74],style:{color:colors[1]}}],size:{height:300,width:980},title:{style:{display:"none"}},xAxis:[{dateTimeLabelFormats:{month:"%b %y",year:"%y",day:"%d"},type:"datetime",showFirstLabel:!1,showLastLabel:!1,startOnTick:!1}],yAxis:[{title:{text:"Applicants",style:{display:"none",color:colors[0]}},labels:{style:{"font-size":"10px","font-weight":"bold",color:colors[0]}}},{gridLineWidth:0,title:{text:"Angel List Score",style:{display:"none",color:colors[1]}},labels:{style:{"font-size":"10px","font-weight":"bold",color:colors[1]}},opposite:!0}],loading:!1}}]),angular.module("n4j.pages.controllers").controller("HomeCtrl",["$scope",function($scope){console.log($scope)}]),angular.module("n4j.pages.controllers").controller("ProfileCtrl",["_","$state","$scope","$n4User","growl",function(_,$state,$scope,$n4User,growl){var _user=null;$n4User.get().then(function(user){_user=_.pick(user,["firstname","lastname","email"]),$scope.user=_.clone(_user)}),$n4User.getSkills().then(function(skills){$scope.skills=skills}),$n4User.getLocations().then(function(locations){$scope.locations=locations}),$scope.save=function(){_.isEqual(_user,$scope.user)?growl.addInfoMessage("Nothing Changed"):$n4User.save($scope.user).then(function(){growl.addSuccessMessage("Profile Successfully Updated")})},$scope.deleteAccount=function(){$n4User.del().then(function(){growl.addSuccessMessage("Sorry to see you go."),setTimeout(function(){$state.go("home")},1500)})}}]),angular.module("n4j.pages.controllers").controller("SetupCtrl",["_","$q","$scope","$state","$n4Auth","$n4Skills","$n4User","growl",function(_,$q,$scope,$state,$n4Auth,$n4Skills,$n4User,growl){var list=null,_original=null,_deletedItems=[],state=$state.is("app.setup.skills")&&"skills"||$state.is("app.setup.locations")&&"locations",extractStringsToCompare=function(arr){return _.map(arr,function(item){return"skills"===state?item.name:"locations"===state?item.city:void 0})};"skills"===state&&(list=$n4Skills.list()),$scope.itemToAdd="","skills"===state?$n4User.getSkills().then(function(skills){_original=_.clone(skills),$scope.selectedItems=skills}):"locations"===state&&$n4User.getLocations().then(function(locations){_original=_.clone(locations),$scope.selectedItems=locations}),$scope.getSuggestion=function(str){return list.then(function(items){var _tmp=extractStringsToCompare($scope.selectedItems),results=_.filter(items,function(item){return"locations"===state?!0:"skills"===state?!_.contains(_tmp,item.name)&&-1!==item.name.toLowerCase().indexOf(str):void 0});return results})},$scope.select=function(item){$scope.selectedItems.push(item),$scope.itemToAdd=""},$scope.onEnter=function(e){13===e.keyCode&&$scope.itemToAdd&&($scope.selectedItems.push({name:$scope.itemToAdd}),$scope.itemToAdd="")},$scope.remove=function(index){_deletedItems.push($scope.selectedItems.splice(index,1)[0])},$scope.save=function(){var promises=[];if(_.isEqual(_original,$scope.selectedItems))growl.addInfoMessage("Nothing Changed");else{var _tmp=null;_tmp=extractStringsToCompare(_original);var _newItems=_.filter($scope.selectedItems,function(item){var strToCompare="skills"===state&&item.name||"locations"===state&&item.city;return!_.contains(_tmp,strToCompare)});if(_newItems.length){var toCreate={};toCreate[state]=_newItems,promises.push($n4User.save(toCreate))}var toDelete={};_tmp=extractStringsToCompare($scope.selectedItems),_deletedItems=_.filter(_deletedItems,function(item){var strToCompare="skills"===state&&item.name||"locations"===state&&item.city;return!_.contains(_tmp,strToCompare)}),toDelete[state]=_deletedItems,_deletedItems.length&&promises.push($n4User.removeRelationships(toDelete)),$q.all(promises).then(function(){growl.addSuccessMessage("Profile Successfully Updated"),setTimeout(function(){$state.go("app.profile")},500)})}}}]),angular.module("n4j.pages.directives").directive("home",function(){var def={};return def={priority:10,link:function(){}}}),angular.module("n4j.pages.directives").directive("backgroundparticles",function(){function link(scope,element){function paintCanvas(){var grd=ctx.createRadialGradient(W/2,H/2,100,W/2,H/2,400);grd.addColorStop(0,"rgba(215,213,250,1)"),grd.addColorStop(1,"rgba(126,119,231,1)"),ctx.fillStyle=grd,ctx.fillRect(0,0,W,H)}function Particle(){this.x=Math.random()*W,this.y=Math.random()*H,this.vx=-1+3*Math.random(),this.vy=-1+3*Math.random(),this.radius=5,this.draw=function(){ctx.fillStyle="lightblue",ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),ctx.fill()}}function draw(){paintCanvas();for(var i=0;i<particles.length;i++){var p=particles[i];p.draw()}update()}function update(){for(var i=0;i<particles.length;i++){var p=particles[i];p.x+=p.vx,p.y+=p.vy,p.x+p.radius>W?p.x=p.radius:p.x-p.radius<0&&(p.x=W-p.radius),p.y+p.radius>H?p.y=p.radius:p.y-p.radius<0&&(p.y=H-p.radius);for(var j=i+1;j<particles.length;j++){var p2=particles[j];distance(p,p2)}}}function distance(p1,p2){var dist,dx=p1.x-p2.x,dy=p1.y-p2.y;if(dist=Math.sqrt(dx*dx+dy*dy),minDist>=dist){ctx.beginPath(),ctx.strokeStyle="rgba(173,216,230,"+(1.2-dist/minDist)+")",ctx.moveTo(p1.x,p1.y),ctx.lineTo(p2.x,p2.y),ctx.stroke(),ctx.closePath();var ax=dx/1e3,ay=dy/1e3;p1.vx-=ax,p1.vy-=ay,p2.vx+=ax,p2.vy+=ay}}function animloop(){draw(),document.getElementsByClassName("main")[0].style.background="url("+canvas.toDataURL()+")",window.requestAnimFrame(animloop)}console.log("inside link"),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}();var canvas=element[0],ctx=canvas.getContext("2d"),W=window.innerWidth,H=window.innerHeight;canvas.width=W,canvas.height=H;for(var particleCount=30,particles=[],minDist=100,i=0;particleCount>i;i++)particles.push(new Particle);animloop()}return{restrict:"AE",link:link}}),angular.module("n4j.pages.services").service("$n4Auth",["$cookies",function($cookies){var user=$cookies.user;if(user){var matches=user.match(/({.+})+/gi);user=angular.fromJson(matches[0])}return this.isLoggedIn=function(){return!!user},this.getUser=function(){return user},this}]),angular.module("n4j.pages.services").service("$n4Jobs",["_","Restangular","$n4Auth",function(_,Restangular,$n4Auth){var user=$n4Auth.getUser(),_extractJobs=function(jobs){var res=_.map(jobs,function(job){var data=job.data;return data});return res};return this.list=function(type){var params={type:type||""};return Restangular.one("users",user.id).getList("jobs",params).then(function(jobs){return _extractJobs(jobs)})},this}]),angular.module("n4j.pages.services").service("$n4Skills",["_","Restangular",function(_,Restangular){return this.list=function(){return Restangular.all("skills").getList().then(function(nodes){return nodes=_.map(nodes,function(node){var data=node.data;return data})})},this.get=function(id){return Restangular.one("skills",id).get()},this}]),angular.module("n4j.pages.services").service("$n4User",["_","$http","$n4Auth","Restangular",function(_,$http,$n4Auth,Restangular){var baseUrl="/api/v0/users/",config={headers:{api_key:"special-key","Content-Type":"application/x-www-form-urlencoded"}},restAuth=Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl("/auth")}),user=$n4Auth.getUser();return this.save=function(data){var url=baseUrl+user.id;return _.each(data,function(value,key,collection){"object"==typeof value&&(collection[key]=JSON.stringify(value))}),$http.put(url,data,config)},this.get=function(){return restAuth.one("currentUser").get().then(function(user){return user})},this.getSkills=function(){return restAuth.one("currentUser").get().then(function(user){var skills=_.map(user.skills,function(node){return node.data});return skills})},this.getLocations=function(){return restAuth.one("currentUser").get().then(function(user){var locations=_.map(user.locations,function(node){return node.data});return locations=locations.length>0&&locations||[{city:"San Francisco"}]})},this.rateJob=function(jobId,rating){var like="like"===rating&&!0||!1,url=baseUrl+user.id+"/jobs/"+jobId,data={like:like};return $http.post(url,data,config)},this.removeRelationships=function(data){var url=baseUrl+user.id+"/relationships";return _.each(data,function(value,key,collection){"object"==typeof value&&(collection[key]=JSON.stringify(value))}),$http.put(url,data,config)},this.del=function(){var url=baseUrl+user.id;return $http.delete(url,config)},this}]);